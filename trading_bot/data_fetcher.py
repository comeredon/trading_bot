"""\nData Fetcher - Retrieves historical stock data from various markets\n"""\n\nimport yfinance as yf\nimport pandas as pd\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List\n\n\nclass DataFetcher:\n    """Fetches historical stock data from Asian, London, and NYSE markets"""\n    \n    def __init__(self, config):\n        self.config = config\n        self.cache = {}\n    \n    def fetch_market_data(self, market: str, days: int = 3) -> Dict:\n        """\n        Fetch historical data for a specific market\n        \n        Args:\n            market: Market name ('asia', 'london', 'nyse')\n            days: Number of historical days to fetch\n        \n        Returns:\n            Dictionary containing market data and metadata\n        """\n        market_config = self.config.get(f'data_sources.{market}')\n        if not market_config:\n            raise ValueError(f"Unknown market: {market}")\n        \n        end_date = datetime.now()\n        start_date = end_date - timedelta(days=days)\n        \n        indices = market_config.get('indices', [])\n        market_data = {\n            'market': market,\n            'start_date': start_date.strftime('%Y-%m-%d'),\n            'end_date': end_date.strftime('%Y-%m-%d'),\n            'indices': {},\n            'summary': {}\n        }\n        \n        print(f"  Fetching {len(indices)} indices from {market}...")\n        \n        for index_symbol in indices:\n            try:\n                data = self._fetch_ticker_data(index_symbol, start_date, end_date)\n                market_data['indices'][index_symbol] = data\n                print(f"    ✓ {index_symbol}: {len(data)} data points")\n            except Exception as e:\n                print(f"    ✗ {index_symbol}: Error - {str(e)}")\n                market_data['indices'][index_symbol] = None\n        \n        # Calculate summary statistics\n        market_data['summary'] = self._calculate_summary(market_data['indices'])\n        \n        return market_data\n    \n    def _fetch_ticker_data(self, symbol: str, start_date: datetime, \n                          end_date: datetime) -> pd.DataFrame:\n        """Fetch data for a specific ticker symbol"""\n        ticker = yf.Ticker(symbol)\n        data = ticker.history(start=start_date, end=end_date)\n        \n        if data.empty:\n            raise ValueError(f"No data available for {symbol}")\n        \n        return data\n    \n    def _calculate_summary(self, indices_data: Dict) -> Dict:\n        """Calculate summary statistics for market data"""\n        summary = {\n            'total_indices': len(indices_data),\n            'successful_fetches': sum(1 for v in indices_data.values() if v is not None),\n            'avg_daily_change': 0.0,\n            'total_volume': 0,\n            'volatility': 0.0\n        }\n        \n        valid_data = [df for df in indices_data.values() if df is not None and not df.empty]\n        \n        if valid_data:\n            changes = []\n            volumes = []\n            \n            for df in valid_data:\n                if 'Close' in df.columns and len(df) > 1:\n                    daily_change = ((df['Close'].iloc[-1] - df['Close'].iloc[0]) / \n                                   df['Close'].iloc[0] * 100)\n                    changes.append(daily_change)\n                \n                if 'Volume' in df.columns:\n                    volumes.append(df['Volume'].sum())\n            \n            if changes:\n                summary['avg_daily_change'] = sum(changes) / len(changes)\n                summary['volatility'] = pd.Series(changes).std()\n            \n            if volumes:\n                summary['total_volume'] = sum(volumes)\n        \n        return summary\n    \n    def fetch_live_price(self, symbol: str) -> float:\n        """Fetch current live price for a symbol"""\n        ticker = yf.Ticker(symbol)\n        data = ticker.history(period='1d')\n        \n        if not data.empty:\n            return data['Close'].iloc[-1]\n        return None\n